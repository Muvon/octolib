name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'  # Matches semver tags like 0.1.0, 1.0.0, etc.
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (semver format, e.g., 0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
      version: ${{ steps.get_version.outputs.VERSION }}
      changelog: ${{ steps.changelog.outputs.CHANGELOG }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for changelog generation

    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
        echo "VERSION_NO_V=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: Validate semver format
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        # POSIX-compatible regex check for semver
        case "$VERSION" in
          [0-9]*.[0-9]*.[0-9]*)
            # Basic semver format matched
            ;;
          *)
            echo "Error: Tag '$VERSION' is not a valid semver format"
            echo "Expected format: X.Y.Z, X.Y.Z-prerelease, or X.Y.Z+build"
            exit 1
            ;;
        esac

    - name: Generate changelog
      id: changelog
      run: |
        # Get the previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -z "$PREV_TAG" ]; then
          CHANGELOG="Initial release"
        else
          # Generate changelog from commits since last tag
          CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges | head -20)
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- No changes since last release"
          fi
        fi

        # Escape for GitHub output (POSIX compatible)
        CHANGELOG=$(printf '%s\n' "$CHANGELOG" | sed 's/%/%25/g; s/\r/%0D/g' | awk '{printf "%s%0A", $0}' | sed 's/%0A$//')
        echo "CHANGELOG=$CHANGELOG" >> $GITHUB_OUTPUT

    - name: Check if release exists
      id: check_release
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        if gh release view "$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      id: create_release
      if: steps.check_release.outputs.exists == 'false'
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        IS_PRERELEASE="false"

        # Check if this is a prerelease (contains - or is 0.x.x)
        case "$VERSION" in
          *-*|0.*)
            IS_PRERELEASE="true"
            ;;
        esac

        # Create the release as draft
        if [ "$IS_PRERELEASE" = "true" ]; then
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes "${{ steps.changelog.outputs.CHANGELOG }}" \
            --draft \
            --prerelease
        else
          gh release create "$VERSION" \
            --title "Release $VERSION" \
            --notes "${{ steps.changelog.outputs.CHANGELOG }}" \
            --draft
        fi

        # Get release info
        RELEASE_INFO=$(gh release view "$VERSION" --json id,uploadUrl)
        RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id')
        UPLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.uploadUrl')

        echo "id=${RELEASE_ID}" >> $GITHUB_OUTPUT
        echo "upload_url=${UPLOAD_URL}" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-release:
    name: Test Release Build
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [1.91.1]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.rust }}-cargo-
          ${{ runner.os }}-cargo-

    - name: Test build with all features (non-Windows)
      if: runner.os != 'Windows'
      run: cargo build --release --all-features

    - name: Test build with no default features
      run: cargo build --release --no-default-features

    - name: Run tests (all features, non-Windows)
      if: runner.os != 'Windows'
      run: cargo test --release --all-features

    - name: Run tests (no default features, Windows)
      if: runner.os == 'Windows'
      run: cargo test --release --no-default-features

  publish-crate:
    name: Publish to Crates.io
    needs: [create-release, test-release]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@1.91.1

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-publish-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-publish-
          ${{ runner.os }}-cargo-

    - name: Validate version matches tag
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')

        if [ "$VERSION" != "$CARGO_VERSION" ]; then
          echo "âŒ Version mismatch!"
          echo "Git tag: $VERSION"
          echo "Cargo.toml: $CARGO_VERSION"
          echo "Please update Cargo.toml version to match the git tag"
          exit 1
        fi

        echo "âœ… Version validation passed: $VERSION"

    - name: Check if version already published
      id: check_published
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"

        # Check if this version already exists on crates.io
        if cargo search octolib --limit 1 | grep -q "octolib = \"$VERSION\""; then
          echo "already_published=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Version $VERSION already published to crates.io"
        else
          echo "already_published=false" >> $GITHUB_OUTPUT
          echo "âœ… Version $VERSION not yet published"
        fi

    - name: Dry run publish
      if: steps.check_published.outputs.already_published == 'false'
      run: |
        echo "ðŸ” Running dry-run publish to validate package..."
        cargo publish --dry-run --all-features
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

    - name: Publish to crates.io
      if: steps.check_published.outputs.already_published == 'false'
      run: |
        echo "ðŸš€ Publishing to crates.io..."
        cargo publish --all-features
        echo "âœ… Successfully published to crates.io!"
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

    - name: Skip publishing
      if: steps.check_published.outputs.already_published == 'true'
      run: |
        echo "â­ï¸  Skipping crates.io publish - version already exists"

  finalize-release:
    name: Finalize Release
    needs: [create-release, test-release, publish-crate]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Publish release
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"

        # Update release notes with installation instructions
        cat > release_notes.md << EOF
        ## ðŸš€ What's Changed

        ${{ needs.create-release.outputs.changelog }}

        ## ðŸ“¦ Installation

        ### Using Cargo (Recommended)
        \`\`\`bash
        cargo add octolib
        \`\`\`

        Or add to your \`Cargo.toml\`:
        \`\`\`toml
        [dependencies]
        octolib = "${VERSION}"
        \`\`\`

        ### With All Features
        \`\`\`toml
        [dependencies]
        octolib = { version = "${VERSION}", features = ["fastembed", "huggingface"] }
        \`\`\`

        ### With Specific Features
        \`\`\`toml
        # FastEmbed only
        octolib = { version = "${VERSION}", default-features = false, features = ["fastembed"] }

        # HuggingFace only
        octolib = { version = "${VERSION}", default-features = false, features = ["huggingface"] }

        # No embedding providers (API-based only)
        octolib = { version = "${VERSION}", default-features = false }
        \`\`\`

        ## ðŸ“š Documentation

        - [Crates.io](https://crates.io/crates/octolib)
        - [Docs.rs](https://docs.rs/octolib/${VERSION})
        - [GitHub Repository](https://github.com/${{ github.repository }})
        - [Homepage](https://octolib.muvon.io)

        ## ðŸ”— Links

        - **Crates.io**: https://crates.io/crates/octolib/${VERSION}
        - **Documentation**: https://docs.rs/octolib/${VERSION}
        - **Repository**: https://github.com/${{ github.repository }}
        EOF

        # Publish the release (remove draft status)
        gh release edit "$VERSION" --draft=false --notes-file release_notes.md
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
